<!DOCTYPE html>
<html>      
    <head>
        <meta charset="utf-8" />
        <title>Phun CMS file manager</title>
        <script src="scripts/jquery.js" type="text/javascript"></script>
        <script src="scripts/jqueryui.js" type="text/javascript"></script>
        <script src="scripts/jquery.cookie.js" type="text/javascript"></script>
        <script src="scripts/jquery.dynatree.js" type="text/javascript"></script>
        <script src="scripts/phuncms.util.js" type="text/javascript"></script>
        
        <link rel="stylesheet" type="text/css" href="css/jquery_ui/jqueryui.css">
        <link rel="stylesheet" type="text/css" href="css/dynatree/ui.dynatree.css">
        <script type="text/javascript">
            var initialUrl = window.location.hash.replace("#", "").toLowerCase();
            var initialUrlParts = initialUrl.split('/');
            var initialUrlLoading = "/";

            // ckeditor callback model
            function ckEditorCallback(fileId) {
                var funcNum = getParameterByName('CKEditorFuncNum');
                window.opener.CKEDITOR.tools.callFunction(funcNum, contentPath + '/Download' + fileId);
                window.close();
            }
            
            function continueInitialLoad() {
                var tree = $("#tree").dynatree("getTree");

                if (initialUrlLoading != initialUrl && $.isArray(initialUrlParts)) {
                    var part = initialUrlParts.pop();
                    while (initialUrlParts.length > 0 && part == "") {
                        part = initialUrlParts.pop();
                    }
                    if (part == "") return;

                    initialUrlLoading += part;
                    var foundNode = tree.getNodeByKey(initialUrlLoading);
                    if (initialUrlParts.length > 0) {
                        initialUrlLoading += "/";
                        foundNode = tree.getNodeByKey(initialUrlLoading);
                        if (foundNode) {
                            foundNode.expand();
                        }
                    }
                    else if (foundNode) {
                        foundNode.activate();
                    } else {
                        foundNode = tree.getNodeByKey(initialUrlLoading + '/');
                        if (foundNode) {
                            foundNode.activate();
                        }
                    }
                }
                else if (initialUrlLoading == initialUrl) {
                    var foundNode = tree.getNodeByKey(initialUrlLoading);
                    if (foundNode) {
                        foundNode.activate();
                    }
                }
            }

            $(document).ready(function () {
                
                if (window.opener != null) {
                    if (typeof (window.opener) != "undefined" && typeof (window.opener.CKEDITOR) != "undefined")
                        $(".select").show();
                }

                // Attach the dynatree widget to an existing <div id="tree"> element
                // and pass the tree options as an argument to the dynatree() function:
                var tree = $("#tree").dynatree({
                    fx: { height: "toggle", duration: 200 },
                    autoFocus: false,
                    selectMode: 1,
                    clickFolderMode: 1,
                    persist: false,
                    autoCollapse: true,
                    initAjax: {
                        type: "POST",
                        url: contentPath +"/FileManagerDynatree",
                        data: { path: '/' },
                        cache: false
                    },
                    onActivate: function (node) {
                        window.location.hash = node.data.key;
                        $(".path").html(window.location.hash.replace("#", ""));
                        $(".pathinput").val(window.location.hash.replace("#", ""));
                    },
                    onLazyRead: function (node) {
                        node.appendAjax({
                            type: "POST",
                            url: contentPath + "/FileManagerDynatree",
                            data: { path: node.data.key },
                            cache: false,
                            success: function (loadedNode) {
                                var url = window.location.hash.replace("#", "");
                                if (url == "") {
                                    return;
                                }
                                continueInitialLoad();
                            }
                        });
                    },
                    onPostInit: function (isLoading, isError) {
                        if (initialUrlLoading != initialUrl && $.isArray(initialUrlParts)) {
                            initialUrlParts = initialUrlParts.reverse();
                        }
                        continueInitialLoad();
                    }
                });


                function addPage(openEdit) {
                    var node = tree.dynatree("getTree").getNodeByKey(window.location.hash.replace("#", ""));

                    var theName = $("#pageName").val();
                    theName = makeSlug(theName.replace(/\//gi, "").replace(/\\/gi, ""));

                    if (theName != "") {
                        if (!node.data.isFolder) {
                            node = node.getParent();
                        }

                        var newKey = (node.data.key + theName + "\/");
                        if (tree.dynatree("getTree").getNodeByKey(newKey) != null) {
                            alert('Page exists, please use edit instead.');
                            return;
                        }

                        var newNode = node.addChild({ title: theName, key: newKey, isFolder: true, isLazy: true });
                        $.ajax({
                            type: "POST",
                            url: contentPath + "/Create",
                            data: { path: newKey + "_default.vash", data: '<!DOCTYPE html><html><head><title>' + $("#pageName").val() + '</title></head><body></body>' },
                            cache: false,
                            success: function (data) {
                                newNode.activate();
                                if (openEdit) {
                                    window.open(contentPath + "/Edit?path=" + newKey, '', '');
                                }
                            }
                        });
                    }
                }
                

                var addAPage = $("#addAPage").dialog({
                    modal: true,
                    autoOpen: false,
                    width: 500,
                    buttons: {
                        "Add and edit": function () {

                            addPage(true);

                            $(this).dialog("close");
                        },

                        "Add": function () {

                            addPage(false);

                            $(this).dialog("close");
                        },

                        // creates a button to cancel the dialog.
                        "Cancel": function () {

                            // Close the dialog
                            $(this).dialog("close");

                            // Clear any values that may of been entered.
                            $("#pageName").val("");
                        }
                    }
                });

                
                $(".new-page").click(function (e) {
                    var location = window.location.hash.replace("#", "");
                    var node = tree.dynatree("getTree").getNodeByKey(location);

                    if (window.location.hash == "#" || node == null || location.indexOf('/page') != 0) {
                        alert("Please select a folder under page.");
                        return false;
                    }

                    addAPage.dialog('open');
                });

                $(".new-directory").click(function (e) {
                    var node = tree.dynatree("getTree").getNodeByKey(window.location.hash.replace("#", ""));

                    if (window.location.hash == "#" || node == null) {
                        alert("Please select a folder.");
                        return false;
                    }

                    var theName = window.prompt("Enter name of new directory under current directory: ", "");
                    theName = makeSlug(theName.replace(/\//gi, "").replace(/\\/gi, ""));
                    
                    if (theName != null && theName != "") {
                        if (!node.data.isFolder) {
                            node = node.getParent();
                        }
                        
                        var newKey = (node.data.key + theName + "\/");
                        
                        node.addChild({ title: theName, key: newKey, isFolder: true });
                    }
                });

                $(".delete").click(function (e) {
                    if (window.location.hash == "#" || window.location.hash.replace("#", "") == "/") {
                        alert("Root path delete is not allowed.");
                        return false;
                    }

                    var node = tree.dynatree("getTree").getNodeByKey(window.location.hash.replace("#", ""));
                    var parent = node.getParent();
                    var message = "Delete " + (node.data.isFolder ? "folder: " : "file: ");
                    message += node.data.key + "?";
                    if (confirm(message)) {
                        $.ajax({
                            type: "DELETE",
                            url: contentPath + "/Delete",
                            data: { path: window.location.hash.replace("#", "") },
                            cache: false,
                            success: function (data) {
                                parent.removeChild(node);
                            }
                        });
                    }
                });

                $(".upload").click(function (e) {
                    if (window.location.hash == "#") {
                        alert("Please select a folder.");
                        return false;
                    }
                    if ($("#upload").val() == "") {
                        alert("Please select a file.");
                        return false;
                    }
                    return true;
                });

                $(".download").click(function (e) {
                    if (window.location.hash == "#") {
                        alert("Please select a file or folder.");
                        return false;
                    }
                    var node = tree.dynatree("getTree").getNodeByKey(window.location.hash.replace("#", ""));

                    window.open(contentPath + "/Download" + node.data.key, '', '');
                    return true;
                });

                $(".edit").click(function (e) {
                    if (window.location.hash == "#") {
                        alert("Please select a file.");
                        return false;
                    }
                    var node = tree.dynatree("getTree").getNodeByKey(window.location.hash.replace("#", ""));

                    if (node.data.isFolder) {
                        alert("Please select a file.");
                        return false;
                    }

                    window.open(contentPath + "/Edit?path=" + node.data.key, '', '');
                    return true;
                });

                $(".select").click(function (e) {
                    if (window.location.hash == "#") {
                        alert("Please select a file.");
                        return false;
                    }
                    var node = tree.dynatree("getTree").getNodeByKey(window.location.hash.replace("#", ""));

                    if (node.data.isFolder) {
                        alert("Please select a file.");
                        return false;
                    }

                    ckEditorCallback(node.data.key);
                    return true;
                });
                
                $(".open").click(function (e) {
                    if (window.location.hash == "#") {
                        alert("Please select a folder.");
                        return false;
                    }
                    var node = tree.dynatree("getTree").getNodeByKey(window.location.hash.replace("#", ""));

                    if (!node.data.isFolder) {
                        alert("Please select a folder.");
                        return false;
                    }

                    window.open(node.data.key, '', '');
                    return true;
                });
            });

        </script>
        <style type="text/css">
            body { text-align: center; }
            .content {
                margin: 0 auto;
                width: 800px;
                text-align: left;
            }
            .action_menu {
                background-color: white;
                border: 1px solid #BBBBBB;
                padding: 0 0 10px 10px;
            }
        </style>
    </head>
    <body>
        <header>
            <h1><a href="/">Phun Cms File Manager</a></h1>
        </header>
        <div class="content">
            <div class="action_menu">
                <span style="font-weight: bold"> Actions: </span><input type="button" class="open" title="Open selected directory" value="Open"/>  <input type="button" class="download" title="Save selected" value="Download"/> <input type="button" class="delete" title="remove selected" value="Delete"/> <input type="button" class="edit" title="edit selected" value="Edit"/><input type="button" class="new-directory" value="New Directory"/> <input type="button" class="new-page" value="New Page"/> <input type="button" class="select" title="select for editor" value="Select" style="display:none"/> 
                <hr/>
                <table>
                    <tbody>
                        <tr>
                            <td><span style="font-weight: bold">Upload: </span><span class="path" style="padding-right: 20px;">/</span> </td>
                            <td><form method="post" enctype="multipart/form-data" data-action="FileManager"><input type="hidden" name="path" class="pathinput"/><input type="file" name="upload" id="upload"/><input type="submit" value="Upload" class="upload"/></form></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="tree"></div> 
        </div>
        <div id="addAPage" title="Add a page" style="text-align: left">
            <p>Please enter a new page name.  The name you entered will automatically be converted to a url friendly name.</p>
            <div><label for="pageName">Name:</label> <input type="text" id="pageName" name="pageName"></div>
        </div>
    </body>
</html>
